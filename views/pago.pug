doctype html
html(lang="es")
  head
    meta(charset="utf-8")
    meta(name="viewport" content="width=device-width, initial-scale=1")
    title Tenis Master - Pago
    link(rel="preconnect" href="https://fonts.googleapis.com")
    link(rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous")
    link(href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet")
    link(href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet")
    style.
      html,body{
        font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
      }
      body{
        background-image:url('/images/cancha2.jpg');
        background-size:cover;
        background-position:center;
        background-repeat:no-repeat;
        background-attachment:fixed;
      }
      .container-mx{max-width:1200px;margin:0 auto;}
      .bg-blur{background:#ffffffcc;backdrop-filter:blur(4px);border-radius:0.5rem;}
      .card{border:1px solid #e5e7eb;border-radius:1rem;background:#ffffffcc;box-shadow:0 1px 2px rgba(0,0,0,.03);}
      .btn-primary{background:#2E7D32;color:#fff;border-radius:.75rem;padding:.75rem 1rem;font-weight:600;display:inline-flex;align-items:center;justify-content:center;}
      .btn-secondary{background:#1976D2;color:#fff;border-radius:.75rem;padding:.75rem 1rem;font-weight:600;display:inline-flex;align-items:center;justify-content:center;}
      .topbar{position:sticky;top:0;z-index:40;background:#ffffffcc;border-bottom:1px solid #e5e7eb;}

  body
    // HEADER
    header.topbar
      .container-mx.px-4.py-3.flex.items-center.justify-between
        img(
          src="/images/logo-tenis-master.svg",
          alt="Tenis Master",
          class="h-9 w-auto",
          onerror="this.style.display='none'"
        )
        button#nav-toggle(
          type="button"
          aria-expanded="false"
          aria-controls="nav-menu"
          class="md:hidden inline-flex items-center gap-2 px-3 py-2 rounded-lg border text-sm text-gray-700"
        )
          svg(
            xmlns="http://www.w3.org/2000/svg",
            class="w-5 h-5",
            fill="none",
            viewBox="0 0 24 24",
            stroke="currentColor"
          )
            path(
              stroke-linecap="round",
              stroke-linejoin="round",
              stroke-width="2",
              d="M4 6h16M4 12h16M4 18h16"
            )
          span Menú

        nav#nav-menu(
          class="hidden flex-col gap-4 bg-blur p-4 absolute top-16 left-4 right-4 md:static md:flex md:flex-row md:gap-6 md:bg-transparent md:shadow-none md:p-0"
        )
          a(href="/panel" class="hover:text-gray-900 px-2 py-1") Inicio
          a(href="/panel-reservas" class="hover:text-gray-900 px-2 py-1") Reservas
          form(action="/logout" method="POST" class="inline")
            button(type="submit" class="text-red-700 font-medium hover:underline px-2 py-1") Salir

    // CONTENIDO
    main.container-mx.px-4.py-16
      h2.text-3xl.font-semibold.text-white.text-center.mb-6 Pago

      if mensajeExito
        .max-w-3xl.mx-auto.mb-4
          .bg-green-100.border.border-green-300.text-green-800.text-sm.rounded-lg.px-4.py-3
            = mensajeExito
      else if mensaje
        .max-w-3xl.mx-auto.mb-4
          .bg-red-100.border.border-red-300.text-red-800.text-sm.rounded-lg.px-4.py-3
            = mensaje


      section.max-w-3xl.mx-auto
        .card.p-6.space-y-5
          // Encabezado + estado de reserva
          .flex.items-center.justify-between
            h3.text-lg.font-semibold.text-gray-900 Resumen de la reserva
            if reserva && reserva.estado
              span.text-xs.font-semibold.px-3.py-1.rounded-full(
                class= reserva.estado === 'activa' ? 'bg-green-100 text-green-800' : 'bg-gray-200 text-gray-700'
              )= reserva.estado

          // Cliente
          .grid.gap-3(class="md:grid-cols-2")
            div
              span.block.text-sm.text-gray-700 Cliente
              input.mt-1.w-full.rounded-lg.border-gray-300.bg-gray-100.text-gray-700.cursor-not-allowed(
                type="text"
                readonly
                value=(clienteNombreCompleto || '')
                placeholder="Apellido y nombre"
              )
            div
              span.block.text-sm.text-gray-700 Correo electrónico
              input#userEmail.mt-1.w-full.rounded-lg.border-gray-300.bg-gray-100.text-gray-700.cursor-not-allowed(
                type="email"
                readonly
                value=(clienteEmail || '')
                placeholder="cliente@mail.com"
              )

            div
              span.block.text-sm.text-gray-700 Correo electrónico
              input#userEmail.mt-1.w-full.rounded-lg.border-gray-300.bg-gray-100.text-gray-700.cursor-not-allowed(
                type="email"
                readonly
                value=(
                  reserva && reserva.clienteEmail
                    ? reserva.clienteEmail
                    : (reserva && reserva.jugadorId && reserva.jugadorId.username
                        ? reserva.jugadorId.username
                        : (usuario && usuario.username ? usuario.username : '')
                      )
                )
                placeholder="cliente@mail.com"
              )

          // Detalle de la reserva
          div(class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm text-gray-700 mt-2")
            .card.p-4
              strong Cancha:
              |  
              span= reserva && reserva.cancha ? reserva.cancha : '-'

            .card.p-4
              strong Fecha:
              |  
              if fechaDisplay
                span #{fechaDisplay}
              else
                span -

            .card.p-4
              strong Horario:
              |  
              if reserva && (reserva.horaInicio || reserva.horaFin)
                span #{reserva.horaInicio || ''}–#{reserva.horaFin || ''}
              else
                span -

            .card.p-4
              strong Importe:
              |  
              span $ #{importe || 0}
              if precioPorHora
                br
                span.text-xs.text-gray-500 (Precio por hora: $ #{precioPorHora})


          // Datos del pago (solo si ya hay un pago registrado)
          if pago
            .mt-4
              h4.text-base.font-semibold.text-gray-900.mb-2 Datos del pago
              div(class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-700")
                .card.p-4
                  strong Método:
                  |  
                  span #{pago.metodo || '-'}

                .card.p-4
                  strong Titular:
                  |  
                  span #{pago.titular || '-'}

                .card.p-4
                  strong Tarjeta:
                  |  
                  if pago.metodo === 'tarjeta' && pago.ultimos4
                    span Terminada en #{pago.ultimos4}
                  else
                    span No aplica

          // FORMULARIO DE PAGO
          if reserva && reserva.estado === 'activa'
            form(method="POST" action=("/reservas/" + reserva._id + "/pagar") class="space-y-4" id="form-pago")
              // Protección CSRF (si la usás)
              // input(type="hidden" name="_csrf" value=csrfToken)

              label.block
                span.text-sm.text-gray-700 Método
                select(name="metodo" required class="mt-1 w-full rounded-lg border-gray-300 focus:ring-green-700 focus:border-green-700")
                  option(value="") Seleccionar método
                  option(value="tarjeta") Tarjeta
                  option(value="transferencia") Transferencia
                  option(value="mercado_pago") Mercado Pago
                  if usuario && (usuario.rol === 'administrador' || usuario.rol === 'empleado')
                    option(value="efectivo") Efectivo

              div(class="grid grid-cols-1 md:grid-cols-2 gap-4")
                label.block
                  span.text-sm.text-gray-700 Titular
                  input(
                    type="text"
                    name="titular"
                    placeholder="Nombre y apellido"
                    class="mt-1 w-full rounded-lg border-gray-300 focus:ring-green-700 focus:border-green-700"
                    required
                  )
                label.block
                  span.text-sm.text-gray-700 Número de tarjeta
                  input(
                    type="text"
                    name="numero"
                    placeholder="XXXX XXXX XXXX XXXX"
                    class="mt-1 w-full rounded-lg border-gray-300 focus:ring-green-700 focus:border-green-700"
                    required
                  )
                label.block
                  span.text-sm.text-gray-700 Vencimiento
                  input(
                    type="text"
                    name="vencimiento"
                    placeholder="MM/AA"
                    class="mt-1 w-full rounded-lg border-gray-300 focus:ring-green-700 focus:border-green-700"
                    required
                  )
                label.block
                  span.text-sm.text-gray-700 CVV
                  input(
                    type="text"
                    name="cvv"
                    placeholder="***"
                    class="mt-1 w-full rounded-lg border-gray-300 focus:ring-green-700 focus:border-green-700"
                    required
                  )

              .flex.justify-end.pt-2
                button.btn-primary(type="submit") Pagar y confirmar
          else if !mensajeExito
            .mt-3.p-4.bg-yellow-50.border.border-yellow-200.rounded-lg.text-sm.text-yellow-800
              | Solo se puede aplicar pago a reservas con estado 
              strong  activa
              | . Verificá el estado en el panel de reservas.

    // FOOTER
    footer.py-6
      .container-mx.px-4.py-6.text-sm.text-gray-700.text-center
        span(style="color:#d32f2f;background:#ffffffaa;padding:4px 12px;border-radius:6px;")
          | © RedSoft 2025. Todos los derechos reservados.

    // SCRIPT
    script.
      (function(){
        // Menú responsive
        const btn = document.getElementById('nav-toggle');
        const menu = document.getElementById('nav-menu');
        if(btn && menu){
          btn.addEventListener('click', () => {
            const isHidden = menu.classList.contains('hidden');
            menu.classList.toggle('hidden');
            btn.setAttribute('aria-expanded', String(isHidden));
          });
        }

        // Habilitar / deshabilitar campos de tarjeta según método de pago
        const selMetodo = document.querySelector('select[name="metodo"]');
        const inpTitular = document.querySelector('input[name="titular"]');
        const inpNumero = document.querySelector('input[name="numero"]');
        const inpVencimiento = document.querySelector('input[name="vencimiento"]');
        const inpCvv = document.querySelector('input[name="cvv"]');

        function actualizarCamposPago() {
          if (!selMetodo) return;
          const m = selMetodo.value;
          const deshabilitar = (m === 'mercado_pago' || m === 'efectivo');

          const campos = [inpTitular, inpNumero, inpVencimiento, inpCvv];
          campos.forEach(c => {
            if (!c) return;
            c.disabled = deshabilitar;
            c.required = !deshabilitar;
            if (deshabilitar) {
              c.classList.add('bg-gray-100','cursor-not-allowed');
            } else {
              c.classList.remove('bg-gray-100','cursor-not-allowed');
            }
          });
        }

        if (selMetodo) {
          selMetodo.addEventListener('change', actualizarCamposPago);
          // Ejecutar una vez al cargar, por si ya viene seleccionado algo
          actualizarCamposPago();
        }
      })();

